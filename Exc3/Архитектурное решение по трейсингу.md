### Места в системе, которые следует покрыть трейсингом
Наиболее уязвимые (с точки зрения зависания заказа) цепочки вызовов (их хочется видеть в трейсах):
- Расчет стоимости изделия: MES API -> 3d storage -> MES API -> Rabbit MQ -> CRM API -> CRM db
- Подтверждение заказа для производства изделия: CRM -> CRM API -> Rabbit MQ -> MES API -> MES DB
- Создание заказа через API продавца: API user -> MES API -> Rabbit MQ -> CRM API -> CRM db
- Получение списка активных заказов операторами: MES -> MES API -> MES db

Какие данные можно включить в контекст трейсинга:
* trace_id - идентификатор трейса
* span_id - идентификатор операции внтури трейса
* service_name - название микросервиса, в котором происходит операция
* operation_name - название текущей операции ("CreateOrder", "ConfirmOrder", "CalculatePrice", ... )
* operation_time_duration - Длительность операции: чтобы найти узкие места.
* operation_status - Статус операции: успешная, ошибка, таймаут.
* order_id - идентификатор заказа
* user_id - идентификатор пользователя

### Мотивация
1. Ускорение диагностики проблем. Трейсинг предоставляет полный путь выполнения запросов через все сервисы и компоненты системы. 
2. Улучшение качества сервиса. Трейсинг помогает обнаружить задержки в цепочках обработки заказов, что способствует улучшению производительности и сокращению времени ответа для пользователей.
3. Снижение времени на решение инцидентов. С детализацией по trace_id и span_id инженеры могут быстро изолировать проблемные участки кода, не привлекая команды всех сервисов.
4. Оптимизация использования ресурсов. Благодаря трейсингу можно определить, где происходят избыточные запросы, или найти неэффективные операции, влияющие на использование ресурсов.

На какие метрики повлияет внедрение трейсинга:
Технические метрики:
- Среднее время обработки заказа: трейсинг позволяет выявить, какие операции замедляют процесс обработки заказа.
- Доля запросов с ошибками: С помощью статуса операций (`operation_status`) можно легко идентифицировать сервисы или цепочки, которые чаще всего вызывают ошибки.

Бизнес метрики:
- Процент вовремя выполненных заказов
- Время реакции на инциденты, ускоряется локализация проблем

### Предлагаемое решение

[jewerly_c4_model.drawio](tracing_jewerly.drawio)

### Компромиссы
В каких случаях внедрение трейсинга может быть неоправдано:
- В системе используются библиотеки или проприетарные решения, которые не поддерживают интеграцию с инструментами трейсинга.
- Малый масштаб системы или MVP, в этом случае метрик и логирования может быть вполне достаточно.
- Если все сервисы используют разные языки и фреймворки, то внедрение трейсинга потребует значительных ресурсов.
- Инфраструктурные ограничения - у компании нет ресурсов для хранения данных трейсинга.

### Аспекты безопасности
- Внедрение аутентификации, например OAuth 2.0 с корпоративной системой аутентификации (LDAP).
- Определить роли для сотрудников, которые могут иметь доступ к данным трейсинга (на схеме выше это разработчик(Developer))
- Шифрование/маскирование персональных данных в трейсинге.
- Механизм контроля доступа на основе корпоративного VPN и ограничение доступа снаружи.



