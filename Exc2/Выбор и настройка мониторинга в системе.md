### Мотивация
- Мониторинг позволяет наблюдать за метриками каждого компонента, видеть объем нагрузки и процент ошибок. 
- Позволяет оперативно выявлять проблемные места в коде каждого сервиса.
- Метрики позволяют быстро определить на чьей стороне произошла проблема и делегировать ее нужной команде. Нет необходимости привлекать всех инженеров для разбора аварий.
- Можно настроить систему алертинга, чтобы немедленно реагировать на критичные события в системе (т.к. возможности постоянно следить за метриками нет)
- Метрики внутри бизнесовых компонентов могут дать ценную информацию для аналитиков и бизнеса (например, какой тип изделий наиболее востребован).
- Своевременная реакция на проблемные метрики снизит неудовлетворенность и жалобы пользователей.
- Метрики помогают ретроспективно анализировать причины аварий.
- Обеспечение безопасности - мониторинг позволяет выявлять необычные паттерны активности, например резкое увеличение нагрузки.

### Выбор подхода к мониторингу
- RED идеален для мониторинга пользовательских API и сервисов, где важны показатели производительности, стабильности и скорости обработки запросов. 

Его можно использовать в API Gateway, CRM и MES для бизнес-логики сервисов.

- USE подходит для низкоуровневой инфраструктуры, где важно знать состояние ресурсов.

Его можно использовать для инфраструктруной части (например - БД, очереди) сервисов CRM и MES.

### Метрики

#### RabbitMQ:
- Number of dead-letter-exchange letters in RabbitMQ: ярлыки (тип очереди, причина попадания в DLX), сигнализирует о проблемах с обработкой сообщений в очереди
- Number of messages in flight in RabbitMQ: ярлыки(тип очереди), метрика позволит отслеживает как активно используются очереди.

#### Shop API:
Метрики нагрузки:
- Number of requests (RPS) for internet shop API или RPM: ярлыки(тип метода, название метода, название ДЦ)
- Response time (latency) for internet shop API: ярлыки(тип метода, название метода, название ДЦ)
- Number of HTTP 200 for shop API: ярлыки(тип метода, название метода, название ДЦ) - метрика успешных ответов
- Number of HTTP 500 for shop API: ярлыки(тип метода, название метода, название ДЦ) - отдельная метрика для 500-x ошибок, чтобы оперативно отслеживать ошибки сервера
- Number of HTTP code for shop API: ярлыки(тип метода, название метода, название ДЦ) - метрика с кодами бизнесовых ошибок (например, 400)

Инфраструктурные метрики:
- CPU % for Shop API: ярлыки (название сервиса)
- Memory utilization for Shop API: ярлыки (название сервиса)
- Kb transferred (received) and Kb provided (sent) for Shop API:
- Size of shop db instance: ярлыки (url мастера/реплик)

#### CRM API:
Бизнесовые метрики:
- Orders count - ярлыки(источник: shop|mes_api), кол-во заказов, которое создается в системе.
- Orders count per user - ярлыки (источник: shop|mes_api, id пользователя), кол-во заказов в разрезе пользователей.
- Orders completed count -  ярлыки (источник: shop|mes_api), кол-во завершенных заказов
- Orders complete SLA - задержки в выполнении заказов относительно обещанного пользователю срока.

Метрики нагрузки:
- Queue consume error rate - ярлыки(тип очереди), rate ошибок на получение сообщений из очереди
- Queue produce error rate - ярлыки(тип очереди), rate ошибок на публикацию сообщений в очереди, которые публикуются для обработки в MES
- Queue length - ярлыки (тип очередь), длина очереди
- Number of requests (RPS) for CRM API или RPM: ярлыки(тип метода, название метода, название ДЦ)
- Response time (latency) for CRM API: ярлыки(тип метода, название метода, название ДЦ)
- Number of HTTP 200 for CRM API: ярлыки(тип метода, название метода, название ДЦ) - метрика успешных ответов
- Number of HTTP 500 for CRM API: ярлыки(тип метода, название метода, название ДЦ) - отдельная метрика для 500-x ошибок, чтобы оперативно отслеживать ошибки сервера
- Number of HTTP code for CRM API: ярлыки(тип метода, название метода, название ДЦ) - метрика с кодами бизнесовых ошибок (например, 400)

Инфраструктурные метрики:
- CPU % for CRM API: ярлыки (название сервиса)
- Memory utilization for CRM API: ярлыки (название сервиса)
- Kb transferred (received) and Kb provided (sent) for CRM API:
- Size of shop db instance: ярлыки (url мастера/реплик)

#### MES API:

Бизнесовые метрики:
- Orders create time - среднее время изготовления изделия
- Orders search time - время поиска новых изделий, готовых для начала изготовления
- Orders create time per item type - время изготовления в разрезе каждого типа изделия

Метрики нагрузки:
- Queue consume error rate - ярлыки(тип очереди), rate ошибок на получение сообщений из очереди
- Queue produce error rate - ярлыки(тип очереди), rate ошибок на публикацию сообщений в очереди, которые публикуются для обработки в MES
- Queue length - ярлыки (тип очередь), длина очереди
- Number of requests (RPS) for MES API или RPM: ярлыки(тип метода, название метода, название ДЦ)
- Response time (latency) for MES API: ярлыки(тип метода, название метода, название ДЦ)
- Number of HTTP 200 for MES API: ярлыки(тип метода, название метода, название ДЦ) - метрика успешных ответов
- Number of HTTP 500 for MES API: ярлыки(тип метода, название метода, название ДЦ) - отдельная метрика для 500-x ошибок, чтобы оперативно отслеживать ошибки сервера
- Number of HTTP code for MES API: ярлыки(тип метода, название метода, название ДЦ) - метрика с кодами бизнесовых ошибок (например, 400)

Инфраструктурные метрики:
- CPU % for MES API: ярлыки (название сервиса)
- Memory utilization for MES API: ярлыки (название сервиса)
- Kb transferred (received) and Kb provided (sent) for MES API:
- Size of shop db instance: ярлыки (url мастера/реплик)

#### Хранилище для 3D моделей изделий:
- Size of S3 storage

### План действий
1. Развернуть Prometheus с TSDB базой для хранения значений метрик.
2. Добавить в конфигурацию Prometheus `scrape_configs` адреса всех микросервисов, с которых планируется получение метрик.
3. Добавить в сервисы клиентскую библиотеку, через которые будем писать метрики.
4. Начинаем писать метрики в сервисах.
5. Поднять Grafana на отдельном сервере.
6. Добавить Prometheus соединение, указать адрес Prometheus сервера.
7. Добавить отдельные дашборды для каждого микросервиса.
8. На каждом дашборде добавить панели с метриками, которые будут выводить графики.
9. При необходимости на самые критичные метрики навесить алерты.