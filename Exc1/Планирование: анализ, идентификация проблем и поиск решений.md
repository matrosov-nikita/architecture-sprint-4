
### Анализ схемы текущей системы:
1. Отсутствуют системы логирования, мониторинга, которые позволяют подсвечивать узкие места в системе.
   
   **Какие техники логирования и трассировки могут помочь идентифицировать место потери заказов?**
   - Событийное логирование - логируем полный путь заказа, чтобы можно было отследить на каком этапе заказ перестал обрабатываться и потерялся, каждый лог должен содержать всю детали выполняемой операции.
   - Во все логи добавляем идентификатор, например идентификатор заказа, чтобы можно было собрать полный путь конкретного заказа через разные компоненты системы.
   - Логирование ошибок (примеры ошибок: запись в очередь, запись в БД, обработка сообщений из очереди) с уровнем ERROR позволит быстро находить проблемные точки с обработкой заказов.
   - Внедрение распределенной трассировки с помощью инструментов OpenTelemetry, Jaeger поможет визуализировать полный путь создания и обработки заказа, поможет быстро идентифицировать сервис, где потерялся или завис заказ.
2. Неоптимальный расчет стоимости изделий в сервисе MES:
   - Расчет стоимости изделий происходит синхронно. Можно его ускорить и сделать асинхронным: для этого можно создать отдельную очередь для заказов на обработку, создать несколько сабскрайберов-воркеров (кол-во подобрать исходя из доступных ресурсов), которые будут вычитывать заказы из очереди и расчитывать стоимость изделия.
   - Для каждого изделия расчет в MES происходит каждый раз заново, даже если модели изделий являются одинаковыми или однотипными (какие-то параметры совпадают). Это добавляет излишнюю нагрузку на систему MES.
3. Отсутствует кэширование при поиске новых заказов операторами. Чаще всего операторы просматривают один и тот же список заказов, поэтому нет необходимости на каждый запрос ходить в базу.
4. База данных MES использует один инстанс для хранения как "горячих" данных (активных заказов), так и "холодных" данных (завершённых заказов). Это создаёт сложности с производительностью, так как из-за низкой селективности поля "статус" индексация на это поле неэффективна, а с ростом объёма данных поиск по статусам становится всё медленнее. Кроме того, единичный инстанс базы данных не оптимален для обработки большого объёма запросов, что приводит к замедлению работы системы и увеличению времени обработки заказов.
4. Система не использует горизонтальное масштабирование и не имеет централизованного оркестратора, такого как Kubernetes, для управления контейнеризованными приложениями. Это ограничивает способность системы масштабироваться, повышает риски перегрузки серверов и снижает её отказоустойчивость.
5. CI/CD деплой в release и production окружения осуществляется вручную. Это замедляет процесс выпуска новых версий и увеличивает риски, связанные с человеческим фактором.
6. Отсутствие механизма регулировки нагрузки между CRM и MES приводит к перегрузке системы MES при большом объеме запросов. Например, в моменты пиковых нагрузок на Shop или API, MES система не имеет способа замедлить поступление сообщений или приостановить обработку, что в свою очередь может вызывать сбои и нестабильную работу.
7. API для внешних пользователей не имеет механизма балансировки нагрузки и регулировки запросов, что приводит к перегрузке при пиковых нагрузках.

   **Как можно разделить API для внутренних и внешних пользователей, чтобы контролировать внешнюю и внутреннюю нагрузку?**

   Шаг 1. Сделать отдельные эндпойнты для внутренних и внешних пользователях - например, `https://mes.api.com` и `https://internal.mes.api.com`. Для каждого эндпойнты будут свои метрики RPS, RT, Error Rate, и т.д.

   Шаг 2. Добавить API Gateway. Внешний API проходит через строгие политики (rate-limiting, авторизация). Внутренний API работает через отдельный маршрут без строгих политик для запросов.

   Также можно рассмотреть альтернативный способ в виде разделения MES API на 2 отдельных микросервиса, каждый работает со своей базой. Первый сервис использует БД для хранения и обработки заказов. Второй сервис использует свою базу для чтения данных заказов операторами. 
8. **Риски совместного использования одной базы магазином и CRM**:
   - Риски производительности. Магазин и CRM могут обращаться к одним и тем же таблицам, что может вызвать блокировки. Одновременное использование БД при пиковых нагрузках может привести к деградациям выполнения запросов.
   - Риски неконсистентности данных. Магазин и CRM могут обновлять одни и те же данные, используя разные бизнес-правила. Из-за этого данные в какой-то момент могут оказаться некорректными.
   - Риски поддержки/управляемости. Изменения в структуре таблиц БД могут повлиять на оба сервиса. При каждом изменении в одном сервисе, нужно убеждаться, что другой сервис не сломается.
   
   Для минимизации рисков можно использовать физическое разделение данных (каждый сервис использует свою БД) или логическое разделение данных (разделение делается на уровне таблиц одной и той же БД, каждый сервис работает только со "своими" таблицам).

### Инициативы, которые необходимы для устранения нежелательных ситуаций:
1. Внедрить ELK для сбора и анализа логов, настроить мониторинг и визуализацию метрик через Prometheus + Grafana, настроить алерты для критичных событий. Все это в совокупности  снизит время на диагностику системы, повысит стабильность и прозрачность работы системы. В первую очередь необходимо покрыть логами места, где заказ может потеряться или зависнуть (это обработка создания/изменения статуса заказа из очереди в сервисе MES, запись в очередь в сервисе CRM, все внутренние ошибки внутри сервисов, ошибки обработки запросов в API (MES, CRM, Shop), ошибки компонентов для работы с БД). Для наиболее критичных событий (замедление времени обработки заказа, снижение интенсивности создания заказов, рост ошибок в одном из сервисов) создать алерты, которые будут оперативно оповещать инженеров о проблемах в сервисах.
2. Внедрить OpenTelemetry в сервисы, участвущие в обработке заказов. Настроить сбор трасс в Jaeger и реализовать автоматическое связывание событий через trace_id. Научиться визуализировать временные задержки в обработке заказов и выявлять узкие места.
3. Предусмотреть кэширование в MES для расчета стоимости изделий и получения списка заказов. Сделать обработку заказов в сервисе MES асинхронной. 
4. Снижение рисков использования одной БД сервисами CRM и Shop: самый оптимальный способ - физически разделить данные, каждый сервис использует свою БД. Если это невозможно сейчас, то на первой итерации можно сделать логическое разделение (например, сервисы работают только со "своими" таблицами).
5. Разделить горячие и холодные данные в БД MES, например через партиционирование таблиц. Для горячих данных использовать оптимизированные частичные индексы.
6. Для улучшения производительности БД MES внедрить шардирование и репликацию.
7. Контейнеризация приложений: Каждое приложение (онлайн-магазин, CRM, MES) должно быть контейнеризовано с помощью Docker. Это обеспечит консистентность в средах разработки, тестирования и продакшн.
8. Использование Kubernetes для оркестрации: Kubernetes должен использоваться для управления контейнерами, автоматического масштабирования, мониторинга состояния и восстановления в случае сбоев. Kubernetes обеспечит высокую доступность, отказоустойчивость и лёгкость в масштабировании приложений по мере роста нагрузки.
9. Интеграция с CI/CD инструментами (например, Jenkins) для автоматического деплоя на все окружения после успешного прохождения всех тестов. Внедрение интеграционных и end-to-end (E2E) тестов в pipeline. Настройка автоматических проверок качества кода (например, линтеры, проверки на безопасность), чтобы не допускать релиз некорректного кода.
10. Внедрение backpressure между CRM и MES позволит контролировать поток сообщений, предотвращая перегрузку систем. Такой механизм будет замедлять поступление сообщений в моменты пиковых нагрузок, предотвращая сбои и снижая нагрузку на систему.
11. Реализовать две версии эндпойнтов для внешних и внутренних пользователей, внедрить API Gateway для проксирования запросов между этими эндпойнтами.

### Приоритет инициатив и образ новой архитектуры
Через полгода разработчики системы должны в real-time видеть все проблемные места системы, а также на основе метрик прогнозировать будущий рост системы. Система сможет масштабироваться в ответ на увеличивающиеся нагрузки, как в плане увеличения объёма данных, так и количества пользователей.
Оптимизация базы данных, кэширование и использование API Gateway для балансировки нагрузки обеспечат быструю работу системы.

Порядок внедрения инициатив:
1. Внедрение логирования и мониторинга (первоначальный шаг для выявления текущих проблем) исходя из требований, описанных выше.
2. Внедрить трассировку в сервисы, участвующие в обработке заказов (MES, CRM, Shop).
3. Внедрение кэширования в MES для получения списка заказов операторами и для расчета стоимости изделий в системе MES. Сделать обработку заказов в сервисе MES асинхронной.
4. Снизить риски использования одной БД сервисами CRM и Shop: самый оптимальный способ - физически разделить данные, каждый сервис использует свою БД.
5. Внедрение API Gateway, который будет включать rate-limiting, балансировать нагрузку между внешними/внутренними пользователями MES API.
6. Внедрение механизма backpressure между CRM и MES (для регулировки нагрузки между сервисами).
7. Разделение данных в базе данных MES и внедрение шардирования и репликации (улучшение производительности базы данных).
8. Контейнеризация приложений и использование Kubernetes (для масштабируемости и отказоустойчивости).
9. Автоматизация CI/CD процессов (для ускорения разработки и релизов).

В первые полгода в первую очередь нужно стабилизировать состояние текущей системы и подготовить плацдарм для масштабирования, поэтому выделил 3 основных задачи:
1. Внедрение логирования и мониторинга (первоначальный шаг для выявления текущих проблем).
2. Внедрение кэширования в MES (ускорение работы системы). Сделать обработку заказов в сервисе MES асинхронной.
3. Внедрение API Gateway с балансировкой нагрузки и rate-limiting (для предотвращения перегрузки).